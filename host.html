<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8">
<title>Host controle â€“ X-Mas Bingo ðŸŽ„</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
    :root {
        --bg-main: #050b16;
        --bg-panel: #081724;
        --accent: #ff4b4b;
        --accent-soft: rgba(255, 75, 75, 0.25);
        --success: #00c878;
        --danger: #ff4b4b;
        --text-main: #ffffff;
        --text-soft: #a8b3c6;
    }

    * {
        box-sizing: border-box;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
    }

    body {
        margin: 0;
        padding: 16px;
        background: radial-gradient(circle at top, #122033 0%, #050b16 60%, #02040a 100%);
        color: var(--text-main);
        display: flex;
        flex-direction: column;
        align-items: center;
        min-height: 100vh;
    }

    .panel {
        width: 100%;
        max-width: 1100px;
        margin: 30px auto 40px;
        background: var(--bg-panel);
        padding: 24px 20px 28px;
        border-radius: 26px;
        border: 2px solid var(--accent-soft);
        box-shadow: 0 25px 80px rgba(0,0,0,0.75);
    }

    h1 {
        margin: 0;
        text-align: center;
        font-size: 1.3rem;
        margin-bottom: 12px;
    }

    .subtitle {
        text-align: center;
        font-size: 0.75rem;
        color: var(--text-soft);
        margin-bottom: 24px;
    }

    label {
        font-size: 0.75rem;
        color: var(--text-soft);
    }

    input,
    select {
        width: 100%;
        font-size: 0.80rem;
        padding: 6px 8px;
        border-radius: 8px;
        background: #0005;
        border: 1px solid #ffffff22;
        color: var(--text-main);
        margin-top: 4px;
    }

    select {
        cursor: pointer;
    }

    /* BOVENSTE RIJ: titel + handle/ronde/kaart-id */
    .header-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 16px;
        margin-bottom: 16px;
    }

    .header-row h1 {
        margin: 0;
        font-size: 1.1rem;
        font-weight: 400;
    }

    .top-inputs {
        display: flex;
        flex: 1;
        gap: 12px;
    }

    .top-inputs input,
    .top-inputs select {
        flex: 1;
        padding: 8px 10px;
        font-size: 0.85rem;
        border-radius: 8px;
        background: #0005;
        color: var(--text-main);
        border: 1px solid #ffffff22;
    }

    #cardId {
        text-align: center;
        opacity: 0.7;
    }

    /* VLAK MET NUMMERS 1â€“75 */
    .numbers-panel {
        margin-top: 8px;
        padding: 12px 14px 14px;
        background: #0003;
        border-radius: 18px;
        border: 1px solid #ffffff22;
    }

    .number-grid {
        display: grid;
        grid-template-columns: repeat(10, minmax(0, 1fr));
        gap: 4px;
        width: 100%;
        max-width: 900px;
        margin: 0 auto;
    }

    .num {
        background: rgba(255,255,255,0.06);
        border: 1px solid rgba(255,255,255,0.2);
        border-radius: 8px;
        cursor: pointer;
        color: #fff;
        height: 30px;
        line-height: 30px;
        font-size: 16px;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .num.selected {
        background: #00c878;
        border-color: #004422;
        color: #000;
        font-weight: 700;
    }

    /* KNOPPEN-RIJ */
    .button-row {
        display: flex;
        gap: 16px;
        margin-top: 14px;
    }

    .btn {
        background: linear-gradient(90deg, #ff4b4b, #ff8c3c);
        color: #fff;
        padding: 8px 12px;
        border-radius: 20px;
        border: none;
        font-size: 0.9rem;
        cursor: pointer;
        font-weight: 600;
        box-shadow: 0 5px 20px rgba(0,0,0,0.5);
        flex: 1;
    }

    .btn.secondary {
        background: #444;
        box-shadow: 0 5px 15px rgba(0,0,0,0.6);
    }

    .result {
        margin-top: 10px;
        font-size: 0.95rem;
        min-height: 1.2em;
        white-space: pre-line; /* zorgt dat \n op nieuwe regels komt */
    }

    .ok {
        color: var(--success);
    }

    .fail {
        color: var(--danger);
    }

    /* KAART VAN DE SPELER */
    .player-card {
        margin-top: 18px;
        padding: 14px 16px 16px;
        background: #0003;
        border: 1px solid #ffffff22;
        border-radius: 18px;
    }

    .player-card strong {
        font-size: 0.95rem;
    }

    .player-card-grid {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 6px;
        margin-top: 12px;
    }

    .cell {
        padding: 6px 0;
        background: rgba(255,255,255,0.07);
        border: 1px solid rgba(255,255,255,0.18);
        border-radius: 8px;
        text-align: center;
        font-size: 14px;
    }

    .cell.marked {
        background: #00c878;
        color: #000;
        font-weight: 700;
        font-size: 14px;
    }

    .footer {
        text-align: right;
        margin-top: 14px;
        font-size: 0.65rem;
        color: var(--text-soft);
    }

    @media (max-width: 800px) {
        .header-row {
            flex-direction: column;
            align-items: stretch;
        }

        .top-inputs {
            width: 100%;
        }

        .button-row {
            flex-direction: column;
        }
    }
</style>

</head>
<body>

<div class="panel">

    <div class="header-row">
        <h1>Host controle â€“ X-Mas Bingo ðŸŽ„</h1>
        <div class="top-inputs">
            <input id="handleInput" placeholder="@handle">
            <select id="roundSelect">
                <option value="1">Ronde 1</option>
                <option value="2">Ronde 2</option>
                <option value="3">Ronde 3</option>
            </select>
            <input id="cardId" disabled placeholder="â€”">
        </div>
    </div>

    <div class="numbers-panel">
        <div class="number-grid" id="numGrid"></div>
    </div>

    <div class="button-row">
        <button class="btn" id="checkBtn">Controleer bingo</button>
        <button class="btn secondary" id="resetBtn">Reset getrokken nummers</button>
    </div>

    <div id="result" class="result"></div>
    <div id="autoBingoResult" class="result"></div>

    <div class="player-card">
        <strong>Kaart van speler</strong>
        <div id="playerGrid" class="player-card-grid"></div>
    </div>

    <div class="footer">Â© spacesbingo</div>

</div>

<script>
// --- Basis referenties ---
const handleInput = document.getElementById("handleInput");
const roundSelect = document.getElementById("roundSelect");
const playerGrid  = document.getElementById("playerGrid");
const cardIdInput = document.getElementById("cardId");

/* ---------------- RNG voor vaste kaart per speler ---------------- */
function cyrb128(str) {
    let h1 = 1779033703, h2 = 3144134277, h3 = 1013904242, h4 = 2773480762;
    for (let i = 0; i < str.length; i++) {
        let k = str.charCodeAt(i);
        h1 = h2 ^ Math.imul(h1 ^ k, 597399067);
        h2 = h3 ^ Math.imul(h2 ^ k, 2869860233);
        h3 = h4 ^ Math.imul(h3 ^ k, 951274213);
        h4 = h1 ^ Math.imul(h4 ^ k, 2716044179);
    }
    h1 = Math.imul(h3 ^ (h1>>>18), 597399067);
    h2 = Math.imul(h4 ^ (h2>>>22), 2869860233);
    h3 = Math.imul(h1 ^ (h3>>>17), 951274213);
    h4 = Math.imul(h2 ^ (h4>>>19), 2716044179);
    return [(h1^h2^h3^h4)>>>0];
}

function makeRng(seed){
    return function(){
        seed |= 0; seed = (seed + 0x6D2B79F5) | 0;
        let t = Math.imul(seed ^ seed>>>15, 1|seed);
        t = (t + Math.imul(t ^ t>>>7, 61|t)) ^ t;
        return ((t ^ t>>>14)>>>0) / 4294967296;
    }
}

function generateCard(handle, round) {
    handle = handle.replace("@","").toLowerCase();
    const [seed] = cyrb128(handle + "::" + round);
    const rng = makeRng(seed);

    const all = [...Array(75).keys()].map(n => n+1);
    for (let i = all.length - 1; i > 0; i--) {
        const j = Math.floor(rng() * (i + 1));
        [all[i], all[j]] = [all[j], all[i]];
    }
    return all.slice(0, 15).sort((a,b)=>a-b);
}

function generateCardID(handle){
    handle = handle.trim().toLowerCase();
    const [seed] = cyrb128(handle + "::card");
    return "SB-" + String(seed % 1000000).padStart(6,"0");
}

// update kaart-ID input
function updateCardIdFromHandle() {
    const handle = handleInput.value.trim();
    if (!handle) {
        cardIdInput.value = "";
        return;
    }
    cardIdInput.value = generateCardID(handle);
}

// toon kaart van speler (zonder markeringen)
function renderPlayerGrid(numbers, marked = []) {
    playerGrid.innerHTML = "";
    if (!numbers || numbers.length === 0) return;

    const markedSet = new Set(marked);

    numbers.forEach((n) => {
        const cell = document.createElement("div");
        cell.className = "cell" + (markedSet.has(n) ? " marked" : "");
        cell.textContent = n;
        playerGrid.appendChild(cell);
    });
}

function updatePlayerCardForCurrentHandle() {
    const handle = handleInput.value.trim();
    const round  = parseInt(roundSelect.value, 10);
    if (!handle) {
        playerGrid.innerHTML = "";
        return;
    }
    const card = generateCard(handle, round);
    renderPlayerGrid(card);
}

// reset-knop
function resetSelections() {
    document.querySelectorAll(".num.selected").forEach(btn => {
        btn.classList.remove("selected");
    });

    const result = document.getElementById("result");
    result.textContent = "";
    result.className = "result";

    const auto = document.getElementById("autoBingoResult");
    auto.textContent = "";
    auto.className = "result";

    playerGrid.innerHTML = "";
}

// nummer-grid opbouwen
const grid = document.getElementById("numGrid");
for (let i = 1; i <= 75; i++){
    const d = document.createElement("div");
    d.className = "num";
    d.textContent = i;
    d.onclick = () => d.classList.toggle("selected");
    grid.appendChild(d);
}

/* ---------- Bingo regels ---------- */
function checkBingo(cardNums, drawnNums) {
    const drawn = new Set(drawnNums);
    const rows = [
        cardNums.slice(0, 5),
        cardNums.slice(5, 10),
        cardNums.slice(10, 15)
    ];

    const countLines = rows.filter(r => r.every(n => drawn.has(n))).length;
    const full = cardNums.every(n => drawn.has(n));

    return { ok: countLines >= 1, lines: countLines, full };
}

/* ---------- Controleknop ---------- */
document.getElementById("checkBtn").onclick = () => {
    const handle = handleInput.value.trim();
    const round  = parseInt(roundSelect.value, 10);
    const resultBox = document.getElementById("result");

    if (!handle){
        resultBox.textContent = "Vul een @handle in.";
        resultBox.className = "result fail";
        return;
    }

    updateCardIdFromHandle();

    const selectedNumbers = Array.from(document.querySelectorAll(".num.selected"))
        .map(n => parseInt(n.textContent, 10));

    if (selectedNumbers.length === 0){
        resultBox.textContent = "Selecteer getrokken nummers.";
        resultBox.className = "result fail";
        return;
    }

    const card = generateCard(handle, round);

    // kaart tonen met markeringen
    renderPlayerGrid(card, selectedNumbers);

    // bingo check
    const { ok, lines, full } = checkBingo(card, selectedNumbers);

    if (ok){
        if (full){
            resultBox.textContent = `âœ… VOLLE KAART voor ${handle} in ronde ${round}!`;
        } else if (lines === 1){
            resultBox.textContent = `âœ… Bingo! (1 lijn)`;
        } else {
            resultBox.textContent = `âœ… Bingo! (${lines} lijnen)`;
        }
        resultBox.className = "result ok";
    } else {
        resultBox.textContent = "âŒ Geen geldige bingo.";
        resultBox.className = "result fail";
    }

    // ===== NIEUW: alle kaarten in database checken =====
    const drawnNumbersForServer = selectedNumbers;

    fetch('check_bingos.php', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            round: round,
            drawnNumbers: drawnNumbersForServer
        })
    })
    .then(r => r.json())
    .then(data => {
        const box = document.getElementById('autoBingoResult');

        if (data.status !== 'ok') {
            box.textContent = 'Kon automatische bingos niet ophalen.';
            box.className = "result fail";
            return;
        }

        if (!data.bingos || data.bingos.length === 0) {
            box.textContent = 'Geen mogelijke bingos op basis van alle kaarten.';
            box.className = "result";
            return;
        }

        let linesText = 'Mogelijke bingos:\n';
        data.bingos.forEach(b => {
            let type;
            if (b.full) {
                type = 'volle kaart';
            } else if (b.lines === 1) {
                type = '1 lijn';
            } else {
                type = `${b.lines} lijnen`;
            }
            linesText += `${b.handle} (${b.cardId}) â€“ ${type}\n`;
        });

        box.textContent = linesText;
        box.className = "result ok";
    })
    .catch(err => {
        console.error(err);
        const box = document.getElementById('autoBingoResult');
        box.textContent = 'Fout bij automatische bingos.';
        box.className = "result fail";
    });
};

/* --- Reset-knop --- */
document.getElementById("resetBtn").onclick = () => {
    resetSelections();
};

/* --- Veranderen van ronde: kaart en selectie resetten --- */
roundSelect.addEventListener("change", () => {
    resetSelections();
    updatePlayerCardForCurrentHandle();
});

// handle-veld: live kaart-id en kaart tonen
handleInput.addEventListener("input", () => {
    updateCardIdFromHandle();
    updatePlayerCardForCurrentHandle();
});

// init
updateCardIdFromHandle();
updatePlayerCardForCurrentHandle();
</script>

</body>
</html>
