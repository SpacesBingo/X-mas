<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8">
  <title>SpacesBingo â€“ Jouw Bingokaart ðŸŽ„</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    * {
      box-sizing: border-box;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
    }

    body {
      margin: 0;
      padding: 16px;
      background: radial-gradient(circle at top, #122033 0%, #050b16 60%, #02040a 100%);
      color: #fff;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
    }

    .panel {
      width: 100%;
      max-width: 1200px;
      margin: 40px auto 60px;
      background: rgba(5, 20, 35, 0.94);
      border-radius: 26px;
      border: 2px solid rgba(255, 75, 75, 0.45);
      padding: 32px 24px 36px;
      box-shadow: 0 25px 80px rgba(0,0,0,0.75);
      position: relative;
    }

    .header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      width: 100%;
      margin-bottom: 10px;
      gap: 16px;
    }

    .title-block {
      flex: 1;
      text-align: center;
    }

    .header-title {
      margin: 0;
      font-size: 28px;
      font-weight: 700;
      color: #fff;
    }

    .subtitle {
      text-align: center;
      font-size: 14px;
      opacity: 0.85;
      margin: 4px 0 0 0;
      line-height: 1.4;
    }

    .header-qr img {
      width: 130px;
      height: 130px;
      object-fit: contain;
      border-radius: 12px;
      cursor: pointer;
      transition: 0.2s;
    }

    .header-qr img:hover {
      transform: scale(1.05);
      filter: drop-shadow(0 0 4px rgba(255,255,255,0.5));
    }

    label {
      display: block;
      margin-top: 18px;
      margin-bottom: 6px;
      font-size: 13px;
    }

    input {
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.25);
      background: #071624;
      color: #fff;
      font-size: 14px;
    }

    input::placeholder {
      color: rgba(255,255,255,0.4);
    }

    button {
      margin-top: 10px;
      padding: 11px 18px;
      border: none;
      border-radius: 999px;
      background: linear-gradient(90deg, #ff4b4b, #ff9100);
      color: #fff;
      font-weight: 600;
      font-size: 15px;
      cursor: pointer;
      width: 100%;
      box-shadow: 0 10px 25px rgba(0,0,0,0.6);
    }

    button:active {
      transform: translateY(1px);
      box-shadow: 0 6px 18px rgba(0,0,0,0.7);
    }

    #card-section {
      display: none;
      margin-top: 20px;
    }

    #card-owner {
      text-align: center;
      font-size: 15px;
      margin-bottom: 4px;
      font-weight: 600;
    }

    #card-info small {
      display: block;
      text-align: center;
      color: #ccc;
      font-size: 12px;
      margin-bottom: 12px;
      line-height: 1.3;
    }

    .rounds-wrapper {
      display: flex;
      flex-direction: column;
      gap: 16px;
      margin-top: 4px;
    }

    .round {
      border-radius: 14px;
      padding: 12px;
    }

    .r1 { border: 1px solid rgba(239,68,68,0.8); }
    .r2 { border: 1px solid rgba(34,197,94,0.8); }
    .r3 { border: 1px solid rgba(250,204,21,0.8); }

    .round-title {
      font-size: 14px;
      margin-bottom: 6px;
      font-weight: 600;
      text-align: center;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(5, minmax(0, 1fr));
      gap: 6px;
    }

    .cell {
      background: rgba(255,255,255,0.06);
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.25);
      cursor: pointer;
      aspect-ratio: 1 / 1;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 25px;
    }

    .cell.marked {
      background: #ff8a00;
      color: #000;
      border-color: #ffd59e;
      font-weight: 600;
    }

    #footer {
      margin-top: 16px;
      text-align: center;
      font-size: 12px;
      opacity: 0.8;
      line-height: 1.4;
    }

    #cardIdSingle {
      font-family: monospace;
      font-weight: bold;
      color: #fff;
    }

    @media (min-width: 900px) {
      .rounds-wrapper {
        flex-direction: row;
      }
      .round {
        flex: 1;
      }
    }

    @media (max-width: 768px) {
      .header-row {
        flex-direction: column;
      }
      .header-qr {
        display: none; /* QR niet op mobiel */
      }
    }
  </style>
</head>
<body>

  <div class="panel">
    <div class="header-row">
      <div class="title-block">
        <h1 class="header-title">Keek op de Week â€“ X-Mas Bingo ðŸŽ„</h1>
        <p class="subtitle">
          Deze kaart hoort bij jouw X @handle.<br>
          Gebruik dezelfde @handle als je bingo claimt.
        </p>
      </div>

      <div class="header-qr">
        <a href="QR/index.html">
          <img src="QR/qr.png" alt="QR-code naar info" class="qr-large">
        </a>
      </div>
    </div>

    <label for="username">Vul je X @handle in:</label>
    <input id="username" placeholder="@jouwnaam">

    <button onclick="generateCard()">Geef mijn bingokaart</button>

    <div id="card-section">
      <div id="card-owner"></div>

      <div id="card-info">
        <small>1 kaart per @handle Â· 3 rondes Â· klik op een vakje om te markeren</small>
      </div>

      <div class="rounds-wrapper">
        <div class="round r1">
          <div class="round-title">Ronde 1</div>
          <div class="grid" id="round1"></div>
        </div>

        <div class="round r2">
          <div class="round-title">Ronde 2</div>
          <div class="grid" id="round2"></div>
        </div>

        <div class="round r3">
          <div class="round-title">Ronde 3</div>
          <div class="grid" id="round3"></div>
        </div>
      </div>

      <div id="footer">
        Gegenereerd op: <span id="gen-time"></span><br>
        Kaart-ID: <span id="cardIdSingle">â€“</span><br>
        Â© spacesbingo
      </div>
    </div>
  </div>

  <script>
  // ---------- Deterministische RNG ----------
  function cyrb128(str) {
    let h1 = 1779033703, h2 = 3144134277,
        h3 = 1013904242, h4 = 2773480762;
    for (let i = 0, k; i < str.length; i++) {
      k = str.charCodeAt(i);
      h1 = h2 ^ Math.imul(h1 ^ k, 597399067);
      h2 = h3 ^ Math.imul(h2 ^ k, 2869860233);
      h3 = h4 ^ Math.imul(h3 ^ k, 951274213);
      h4 = h1 ^ Math.imul(h4 ^ k, 2716044179);
    }
    h1 = Math.imul(h3 ^ (h1 >>> 18), 597399067);
    h2 = Math.imul(h4 ^ (h2 >>> 22), 2869860233);
    h3 = Math.imul(h1 ^ (h3 >>> 17), 951274213);
    h4 = Math.imul(h2 ^ (h4 >>> 19), 2716044179);
    return [(h1 ^ h2 ^ h3 ^ h4) >>> 0];
  }

  function makeRng(seed) {
    return function() {
      seed |= 0; seed = (seed + 0x6D2B79F5) | 0;
      let t = Math.imul(seed ^ seed >>> 15, 1 | seed);
      t = (t + Math.imul(t ^ t >>> 7, 61 | t)) ^ t;
      return ((t ^ t >>> 14) >>> 0) / 4294967296;
    }
  }

  function generateNumbers(handle, roundIndex) {
    handle = handle.replace("@", "").toLowerCase();
    const [seed] = cyrb128(handle + "::" + roundIndex);
    const rng = makeRng(seed);

    const all = [...Array(75).keys()].map(n => n + 1);
    for (let i = all.length - 1; i > 0; i--) {
      const j = Math.floor(rng() * (i + 1));
      [all[i], all[j]] = [all[j], all[i]];
    }
    return all.slice(0, 15).sort((a,b)=>a-b);
  }

  function generateCardId(handle) {
    const base = handle.trim().toLowerCase();
    const [seed] = cyrb128(base + "::card");
    return "SB-" + String(seed % 1000000).padStart(6, "0");
  }

  // ---------- localStorage helpers ----------
  function getPlayerStorageKey(handle, cardId, round) {
    return `playerMarks_${handle}_${cardId}_R${round}`;
  }

  function savePlayerMarks(handle, cardId, round) {
    const key = getPlayerStorageKey(handle, cardId, round);
    const selector = `.cell.marked[data-round="${round}"]`;
    const selectedCells = Array.from(document.querySelectorAll(selector));
    const numbers = selectedCells.map(c => parseInt(c.dataset.number, 10));
    localStorage.setItem(key, JSON.stringify(numbers));
  }

  function restorePlayerMarks(handle, cardId, round) {
    const key = getPlayerStorageKey(handle, cardId, round);
    const saved = localStorage.getItem(key);
    if (!saved) return;

    const numbers = JSON.parse(saved);
    const cells = document.querySelectorAll(`.cell[data-round="${round}"]`);
    cells.forEach(c => {
      const n = parseInt(c.dataset.number, 10);
      if (numbers.includes(n)) {
        c.classList.add("marked");
      }
    });
  }

  // ---------- hoofd-functie ----------
  function generateCard() {
    let handle = document.getElementById("username").value.trim();

    if (!handle) {
      alert("Vul je X @handle in.");
      return;
    }
    if (!handle.startsWith("@")) {
      alert("Een X-handle moet beginnen met @");
      return;
    }

    const cardId = generateCardId(handle);

    // kaart zichtbaar maken + teksten zetten
    document.getElementById("card-section").style.display = "block";
    document.getElementById("card-owner").textContent = "Kaart voor: " + handle;
    document.getElementById("cardIdSingle").textContent = cardId;

    const now = new Date();
    document.getElementById("gen-time").textContent =
      now.toLocaleDateString("nl-NL") + " " +
      now.toLocaleTimeString("nl-NL", {hour:"2-digit", minute:"2-digit"});

    // ===== Log deelnemer + kaart in database =====
    (function () {
      const round1Nums = generateNumbers(handle, 1);
      const round2Nums = generateNumbers(handle, 2);
      const round3Nums = generateNumbers(handle, 3);

      fetch('log_participant.php', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          handle: handle,
          cardId: cardId,
          round1: round1Nums.join(','),
          round2: round2Nums.join(','),
          round3: round3Nums.join(',')
        })
      }).catch(err => {
        console.error('Loggen van deelnemer mislukt:', err);
      });
    })();
    // ===== EINDE logging =====

    // 3 rondes tekenen + opgeslagen markeringen herstellen
    for (let r = 1; r <= 3; r++) {
      const nums = generateNumbers(handle, r);
      const grid = document.getElementById("round" + r);
      grid.innerHTML = "";

      nums.forEach(n => {
        const cell = document.createElement("div");
        cell.className = "cell";
        cell.textContent = n;
        cell.dataset.number = n;
        cell.dataset.round = r;

        cell.onclick = () => {
          cell.classList.toggle("marked");
          const h = document.getElementById("username").value.trim();
          const cId = generateCardId(h);
          if (h && cId) {
            savePlayerMarks(h, cId, r);
          }
        };

        grid.appendChild(cell);
      });

      // herstel eerder aangeklikte nummers voor deze ronde
      restorePlayerMarks(handle, cardId, r);
    }
  }
  </script>

</body>
</html>
